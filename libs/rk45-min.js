var rk45=function(){this.x0=null,this.fn=null,this.newX=null,this.h=.1,this.tol=1e-5,this.start=0,this.stop=1,this.R=null,this.delta=null,this.count=0,this.maxCount=2048,this.status={success:!1,state:"init",message:null},this.debug=!1,this.standard_h=null};rk45.prototype={setInitX:function(a){return this.x0=a},setFn:function(a){return this.fn=a},setStart:function(a){return this.start=a},setStop:function(a){return this.stop=a},setH:function(a){return this.standard_h=a,this.h=a},setTol:function(a){return this.tol=a},setMaxCount:function(a){return this.maxCount=a},resetStatus:function(){return this.status={success:!1,state:"init",message:null}},reset:function(){this.resetStatus(),null===this.standard_h?this.setH(.1):this.setH(this.standard_h)},adoptCurrentState:function(){this.reset(),this.setStart(this.stop),this.setInitX(this.newX.slice())},solveTimes:function(a,b=!1){let c=[],d=this.x0.slice(),e=this.start,f=this.stop,g=this.h;this.setStart(a[0]),c.push(this.x0.slice());for(let d=1;d<a.length;++d)this.setStop(a[d]),this.solve(b),c.push(this.newX.slice()),this.adoptCurrentState();return this.reset(),this.setInitX(d),this.setStart(e),this.setH(g),c},getStatus:function(){return this.status},checkSetUp:function(){return this.start>=this.stop?(this.status.state="error",this.status.message=this.start==this.stop?"Stop time same as start time.":"Stop time is less than start time.",this.status.state):this.x0.length==this.fn.length?0>=this.h?(this.status.state="error",this.status.message=0==this.h?"h is zero but must be a positive number.":"h is less than zero but must be a positive number.",this.status.state):"ok":(this.status.state="error",this.status.message="Dimension of initial conditions not the same as dimension of functions.",this.status.state)},computeK:function(a){for(var b=a,c=this.newX.slice(),d=this.x0.length,e=Array(d),f=0;f<d;f++)e[f]=[,,,,,,],e[f][0]=this.h*this.fn[f](b,c);b=a+this.h/4;for(var f=0;f<d;f++)c[f]=this.newX[f]+e[f][0]/4;for(var f=0;f<d;f++)e[f][1]=this.h*this.fn[f](b,c);b=a+3*this.h/8;for(var f=0;f<d;f++)c[f]=this.newX[f]+(3*e[f][0]+9*e[f][1])/32;for(var f=0;f<d;f++)e[f][2]=this.h*this.fn[f](b,c);b=a+12*this.h/13;for(var f=0;f<d;f++)c[f]=this.newX[f]+(1932*e[f][0]-7200*e[f][1]+7296*e[f][2])/2197;for(var f=0;f<d;f++)e[f][3]=this.h*this.fn[f](b,c);b=a+this.h;for(var f=0;f<d;f++)c[f]=this.newX[f]+439*e[f][0]/216-8*e[f][1]+3680*e[f][2]/513-845*e[f][3]/4104;for(var f=0;f<d;f++)e[f][4]=this.h*this.fn[f](b,c);b=a+this.h/2;for(var f=0;f<d;f++)c[f]=this.newX[f]-8*e[f][0]/27+2*e[f][1]-3544*e[f][2]/2565+1859*e[f][3]/4104-11*e[f][4]/40;for(var f=0;f<d;f++)e[f][5]=this.h*this.fn[f](b,c);return e},solve:function(a=!1){if(!(a&&"ok"!=this.checkSetUp())){var b=this.x0.length,c=this.start;for(this.newX=Array(b),this.newX=this.x0,this.R=Array(b),this.delta=Array(b),this.count=0;c<this.stop;){this.debug&&console.log("t: "+c+", newX: "+this.newX);var d=this.computeK(c);if(this.debug)for(var e=0;e<d.length;e++)console.log("k["+e+"]: "+d[e]);for(var e=0;e<b;e++)this.R[e]=Math.abs(d[e][0]/360-128*d[e][2]/4275-2197*d[e][3]/75240+d[e][4]/50+2*d[e][5]/55),this.R[e]/=this.h,this.delta[e]=.84*Math.pow(this.tol/this.R[e],.25);if(this.debug&&console.log("delta: "+this.delta+"; min: "+Math.min.apply(null,this.delta)),Math.max.apply(null,this.R)<=this.tol){this.debug&&console.log("Good to compute!"),c+=this.h;for(var e=0;e<b;e++)this.newX[e]+=25*d[e][0]/216+1408*d[e][2]/2565+2197*d[e][3]/4104-d[e][4]/5;this.h*=Math.min.apply(null,this.delta)}else this.debug&&(console.log("Need to adjust step size, max R: "+Math.max.apply(null,this.R)),console.log("Scale factor: "+Math.min.apply(null,this.delta))),this.h*=Math.min.apply(null,this.delta);if(this.h>=this.stop-c&&(this.h=this.stop-c),this.count++>this.maxCount)break}this.count++>this.maxCount?(this.status.success=!1,this.status.state="error",this.status.message="Iteration count exceeded MAX count ("+this.maxCount+")"):c>=this.stop&&(this.status.success=!0,this.status.state="complete",this.status.message="Integration completed sucessfully.")}}};
